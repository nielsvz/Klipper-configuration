[gcode_macro FILTER_START]
gcode:
  {% set FILAMENT_TYPE = printer['gcode_macro _PRINT_VARIABLES'].filament_type | string %}
  {% set filter_speed = params.SPEED | default(0.65) | float %}
  {% if FILAMENT_TYPE not in ("NO-FILAMENT", "PLA", "PET", "PETG", "FLEX") %}
  M117 Filter { filter_speed * 100 | int }%
  SET_FAN_SPEED FAN=filter SPEED={ filter_speed }
  {% endif %}

[gcode_macro FILTER_STOP]
gcode:
  {% set PURGE = params.PURGE | default(0) | int %}
  {%  if PURGE %}
    UPDATE_DELAYED_GCODE ID=_FILTER_STOP DURATION=1
  {% else %}
    M117 Filter off
    SET_FAN_SPEED FAN=filter SPEED=0.0
  {% endif %}

[delayed_gcode _FILTER_STOP]
gcode:
  {% if printer.heater_bed.temperature > 50.0 and printer.heater_bed.target == 0.0 %}
    UPDATE_DELAYED_GCODE ID=_FILTER_STOP DURATION=60
  {% else %}
    FILTER_STOP
    UPDATE_DELAYED_GCODE ID=CLEAR_DISPLAY DURATION=60
  {% endif %}
