[gcode_macro FILTER_START]
gcode:
  {% set filter_speed = 0.65 %}
  {% if FILAMENT_TYPE not in ("PLA", "PET", "PETG", "FLEX") %}
  M117 Filter { filter_speed * 100 | int }%
  SET_FAN_SPEED FAN=filter SPEED={ filter_speed | float }
  {% endif %}

[gcode_macro FILTER_MAX]
gcode:
  M117 Filter { 100 | int }%
  SET_FAN_SPEED FAN=filter SPEED=1.0

[gcode_macro FILTER_STOP]
gcode:
  M117 Filter off
  SET_FAN_SPEED FAN=filter SPEED=0.0

[delayed_gcode FILTER_STOP]
gcode:
  {% if printer.heater_bed.temperature > 50.0 and printer.heater_bed.target == 0.0 %}
    UPDATE_DELAYED_GCODE ID=FILTER_STOP DURATION=60
  {% else %}
    FILTER_STOP
    UPDATE_DELAYED_GCODE ID=CLEAR_DISPLAY DURATION=60
  {% endif %}
