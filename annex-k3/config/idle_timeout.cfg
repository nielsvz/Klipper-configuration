[idle_timeout]
timeout: 1800
gcode:
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% set raise_z = 30 %}
  {% if act_z < (max_z - raise_z) %}
    {% set z_safe = raise_z %}
  {% else %}
    {% set z_safe = max_z - act_z %}
  {% endif %}
  {% if printer.toolhead.homed_axes == 'xyz' %}
    G91                                                   ; relative positioning
    G0 Z{z_safe} F600                                     ; move Z axis up 30mm
    G90                                                   ; use absolute coordinates
    G0 X170 Y170 F6000                                     ; move away from the bed
  {% endif %}
  M84                                                     ; turn off motors
  TURN_OFF_HEATERS
  FILTER_STOP PURGE=1                                     ; stop filter after heated bed has cooled
