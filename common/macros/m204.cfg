[gcode_macro M204]
description: Override the default M204 command and properly set accel and accel_to_decel
rename_existing: M204.1
gcode:
  {% set P = params.P | default (0.0) | float %}
  {% set S = params.S | default (0.0) | float %}
  {% set T = params.T | default (0.0) | float %}

  {% set param_accel = [P, S, T] | max %}
  {% set max_accel = printer.configfile.settings.printer.max_accel | float %}
  {% set accel = [param_accel, max_accel] | min %}

  {% set max_accel_to_decel = printer.configfile.settings.printer.max_accel_to_decel | float %}
  {% set accel_to_decel = accel * (max_accel_to_decel / max_accel) %}

  {% if accel > 0.0 %}
    SET_VELOCITY_LIMIT ACCEL={ accel } ACCEL_TO_DECEL={ accel_to_decel }
  {% endif %}
